---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner-internal
  namespace: development
spec:
  interval: 15m
  chart:
    spec:
      chart: gitlab-runner
      version: 0.77.0
      sourceRef:
        kind: HelmRepository
        name: gitlab
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    image:
      registry: registry.gitlab.com
      image: gitlab-org/gitlab-runner
      tag: alpine-v18.6.2
    replicas: 1
    imagePullSecrets:
      - name: harbor-registry-secret
    podAnnotations:
      reloader.stakater.com/search: "true"
    gitlabUrl: https://gitlab.${SECRET_DOMAIN}
    rbac:
      create: true
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    service:
      enabled: true
    runners:
      name: "internal-gitlab-runner"
      executor: kubernetes
      runUntagged: true
      secret: gitlab-runner-internal-secret
      config: |
        [[runners]]
          [runners.kubernetes]
            privileged = true
            image_pull_secrets=["harbor-registry-secret"]
            allow_privilege_escalation = true
    unregisterRunners: true
    concurrent: 2
    securityContext:
      allowPrivilegeEscalation: true
      readOnlyRootFilesystem: false
      runAsNonRoot: false
      privileged: true
      capabilities:
        drop: ["ALL"]

    extraContainers:
      - name: buildkitd
        image: moby/buildkit:rootless
        args:
          - --addr
          - unix:///run/user/1000/buildkit/buildkitd.sock
          - --addr
          - tcp://0.0.0.0:1234
          - --oci-worker-no-process-sandbox
        ports:
          - containerPort: 1234
        securityContext:
          seccompProfile:
            type: Unconfined
          appArmorProfile:
            type: Unconfined
          # To change UID/GID, you need to rebuild the image
          runAsUser: 1000
          runAsGroup: 1000
        volumeMounts:
          # Dockerfile has `VOLUME /home/user/.local/share/buildkit` by default too,
          # but the default VOLUME does not work with rootless on Google's Container-Optimized OS
          # as it is mounted with `nosuid,nodev`.
          # https://github.com/moby/buildkit/issues/879#issuecomment-1240347038
          - mountPath: /home/user/.local/share/buildkit
            name: buildkitd

    volumes:
      - name: buildkitd
        emptyDir: {}
    extraObjects:
      - apiVersion: v1
        kind: Service
        metadata:
          name: buildkitd
          namespace: gitlab-runner
        spec:
          selector:
            app: gitlab-runner
          ports:
            - protocol: TCP
              port: 1234
              targetPort: 1234
